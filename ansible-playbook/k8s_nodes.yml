- hosts: nodes
  become: yes
  gather_facts: True
  tasks:
    - name: include vars
      include_vars: /vagrant/ansible-playbook/kubeadm-join.yaml


    # HostOnly Interface の IPアドレス取得
    #
    - name: getting hostonly ip address
      command: ifconfig enp0s8
      register: ip
    - debug: var=ip.stdout_lines[1].split(':')[1].split(' ')[0]

    # 10-kubeadmin.conf に --node-ipを追加
    #
    - name: change 10-kubeadm.conf
      replace:
        dest: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
        regexp: 'KUBELET_EXTRA_ARGS$'
        replace: KUBELET_EXTRA_ARGS --node-ip={{ ip.stdout_lines[1].split(':')[1].split(' ')[0] }} --cluster-dns=10.244.0.10

    # 変更を反映
    #
    - name: daemon-reload and restart kubelet 変更を反映
      systemd:
        state: restarted
        daemon_reload: yes
        name: kubelet


    # k8sノードをクラスタへ参加
    #
    - debug: var=join_command
    - name: kubeadm reset
      command: kubeadm reset -f
    - name: kubeadm join
      command: "{{ join_command }}"

    # kubeletのDNSのIPアドレスを変更
    #
    - name: change config.yaml
      replace:
        dest: /var/lib/kubelet/config.yaml
        regexp: '10.96.0.10'
        replace: 10.244.0.10

    # kubeletをリスタートして変更を反映
    #
    - name: daemon-reload and restart kubelet
      systemd:
        state: restarted
        daemon_reload: yes
        name: kubelet


