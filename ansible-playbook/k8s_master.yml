- hosts: master
  become: yes
  become_user: root  
  gather_facts: True
  vars:
    join_cmd: /vagrant/ansible-playbook/kubeadm-join.yaml

  tasks:
    - name: include k8s vartsion
      include_vars: /vagrant/ansible-playbook/versions.yml

    ## k8sマスタを初期化
    #
    - name: "kubeadm reset v1.11 or later"
      command: kubeadm reset -f
      when: k8s_minor_ver|int >= 11

    - name: "kubeadm reset v1.10 or eary"
      command: kubeadm reset
      when: (k8s_minor_ver == "10") or (k8s_minor_ver == "9")

    ## HostOnly Interface の IPアドレス取得
    #
    - name: getting hostonly ip address
      command: ifconfig enp0s8
      register: ip

    - name: kubeadm init
      command: kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address={{ ip.stdout_lines[1].split(':')[1].split(' ')[0] }} --service-cidr=10.32.0.0/24
      register: join


    ## k8sノード用コマンドを保存
    #
    - name: rm "{{ join_cmd }}"
      command: rm -f {{ join_cmd }}
    - shell: echo "join_command" ":" {{ join.stdout_lines[-1] }} > {{ join_cmd }}


    ## kubeletのDNSのIPアドレスを変更
    #
    - name: change config.yaml
      replace:
        dest: /var/lib/kubelet/config.yaml
        regexp: '10.96.0.10'
        replace: 10.32.0.10
      when: k8s_minor_ver|int > 11

    ## kubeletをリスタートして変更を反映
    #
    - name: daemon-reload and restart kubelet
      systemd:
        state: restarted
        daemon_reload: yes
        name: kubelet

    ## kubeconfigディレクトリ作成
    #
    - name: mkdir kubeconfig
      file:
        path:  /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode:  0755

    ##  configファイルのコピー
    #
    #- name: copy config
    #  copy:
    #    src:  /etc/kubernetes/admin.conf
    #    dest: /home/vagrant/.kube/config
    #    owner: root
    #    group: root
    #    mode:  0644
    - shell: cp /etc/kubernetes/admin.conf /home/vagrant/.kube/config
    - shell: chown vagrant:vagrant /home/vagrant/.kube/config
    - shell: chmod 0600 /home/vagrant/.kube/config
    - shell: rm -fr /vagrant/kubeconfig
    - shell: cp -fr /home/vagrant/.kube /vagrant/kubeconfig


    ## flannelのマニフェストダウンロード
    #
    - name: download Manifest of Flannel for k8s ver <=11
      get_url:
        url: https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml
        dest: /home/vagrant/
        mode: 0644
        owner: vagrant
        group: vagrant
      when: k8s_minor_ver|int <= 11

    - name: download Manifest of Flannel for k8s ver > 11
      get_url:
        url: https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml
        dest: /home/vagrant/
        mode: 0644
        owner: vagrant
        group: vagrant
      when: k8s_minor_ver|int > 11


    ## インタフェースの追加
    #
    - name: add a new line
      blockinfile:
        dest: /home/vagrant/kube-flannel.yml
        insertafter: '--kube-subnet-mgr$'
        content: '        - --iface=enp0s8'

    ## Flannelのデプロイ
    #
    - name: Deploy Flannel 
      become_user: vagrant
      command: kubectl apply -f /home/vagrant/kube-flannel.yml
      
